<!-- admin.html -->
<div class="admin-container">
    <h1>Área Administrativa SISLAB</h1>
    <p class="warning">Cuidado: As ações nesta página podem ser irreversíveis!</p>

    <button onclick="mostrarLogGeralInventario()">Ver Log Geral de Inventário</button>
    <button class="danger-button" onclick="limparHistoricoAdmin()">Limpar TODO o Histórico do Firebase</button>
    <button onclick="carregarPacienteFicticio()">Carregar Paciente Fictício</button>

    <p>Voltar para o <a href="index.html">Cadastro de Exames</a></p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, limit, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA_LEim5s-_NSCk3ySVCcUzDjIq0RPlvnA",
        authDomain: "sislab-cetep.firebaseapp.com",
        projectId: "sislab-cetep",
        storageBucket: "sislab-cetep.firebasestorage.app",
        messagingSenderId: "958611861664",
        appId: "1:958611861664:web:97a3755f2b1958b0c8d9c5",
        measurementId: "G-3TL54MWJFS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.firestoreDb = db;
    window.firebaseFirestoreCollection = collection;
    window.firebaseFirestoreGetDocs = getDocs;
    window.firebaseFirestoreQuery = query;
    window.firebaseFirestoreLimit = limit;
    window.firebaseFirestoreWriteBatch = writeBatch;
    window.firebaseFirestoreOrderBy = orderBy;
</script>

<script>
    const SENHA_LIMPAR_HISTORICO = "sislab";

    async function limparHistoricoAdmin() {
        const senhaDigitada = prompt("Para limpar o histórico, digite a senha:");
        if (senhaDigitada === null) return;
        if (senhaDigitada === SENHA_LIMPAR_HISTORICO) {
            if (!window.firestoreDb) {
                alert("Firestore não inicializado. Limpeza de histórico desabilitada.");
                return;
            }
            const confirmDeleteAll = confirm("Tem certeza que deseja apagar TODO o histórico do Firebase? Esta ação é irreversível!");
            if (!confirmDeleteAll) return;

            try {
                const historicoRef = window.firebaseFirestoreCollection(window.firestoreDb, 'historico');
                const batchSize = 100;

                const deleteQueryBatch = async (db, q) => {
                    const snapshot = await window.firebaseFirestoreGetDocs(q);
                    if (snapshot.empty) return 0;
                    const batch = window.firebaseFirestoreWriteBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    return snapshot.size;
                };

                let totalDeleted = 0, deletedCount;
                do {
                    const q = window.firebaseFirestoreQuery(historicoRef, window.firebaseFirestoreLimit(batchSize));
                    deletedCount = await deleteQueryBatch(window.firestoreDb, q);
                    totalDeleted += deletedCount;
                    await new Promise(resolve => setTimeout(resolve, 50));
                } while (deletedCount === batchSize);

                alert(`Histórico apagado com sucesso! Total de ${totalDeleted} registros.`);
            } catch (error) {
                console.error("Erro ao limpar histórico:", error);
                alert("Erro ao limpar histórico. Verifique o console.");
            }
        } else {
            alert('Senha incorreta. Histórico não foi limpo.');
        }
    }

    async function mostrarLogGeralInventario() {
        alert("Redirecionando para a página do Log Geral de Inventário (a ser implementada).\n\nOu pressione F12 > Console para visualizar o backend.");
        window.location.href = 'log_inventario.html';
    }

    async function carregarPacienteFicticio() {
        try {
            const response = await fetch('pacientes_aleatorios.json');
            const pacientes = await response.json();
            const paciente = pacientes[Math.floor(Math.random() * pacientes.length)];
            localStorage.setItem('pacienteFicticio', JSON.stringify(paciente));
            window.location.href = 'index.html?preencher=ficticio';
        } catch (err) {
            console.error("Erro ao carregar paciente fictício:", err);
            alert("Erro ao carregar paciente fictício. Verifique se o arquivo JSON está acessível.");
        }
    }
</script>

<!-- 
Changelog:
- Substituído botão "Imprimir Paciente Fictício" por "Carregar Paciente Fictício".
- Função 'imprimirPacienteFicticio()' renomeada e alterada para 'carregarPacienteFicticio()', apenas preenche os campos.
-->
