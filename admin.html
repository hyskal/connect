<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SISLAB - Administração V2.0.7</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .admin-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: center;
        }
        h1 {
            color: #1A2B4C;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #1A2B4C; /* Cor padrão para botões admin */
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0F1D33;
        }
        /* Estilo específico para o botão de limpar histórico, se for de "perigo" */
        button.danger-button {
            background-color: #CC3333; /* Vermelho para ação perigosa */
        }
        button.danger-button:hover {
            background-color: #A02222;
        }
        p.warning {
            color: #CC3333;
            font-weight: bold;
        }
        /* Estilos para o editor de exames */
        #editorExames {
            display: none;
            margin-top: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 95%; /* Ajuste a largura conforme necessário */
            max-width: 600px; /* Limite a largura para melhor visualização */
        }
        #editorExames textarea {
            width: 100%;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 10px;
            resize: vertical;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="admin-container">
        <h1 id="adminTitle">Área Administrativa SISLAB V2.0.5</h1>
        <p class="warning">Cuidado: As ações nesta página podem ser irreversíveis!</p>
        
        <button onclick="mostrarLogGeralInventario()">Ver Log Geral de Inventário</button>
        
        <button class="danger-button" onclick="limparHistoricoAdmin()">Limpar TODO o Histórico do Firebase</button>
        
        <button onclick="gerarNovoPacienteAleatorio()">Gerar Novo Paciente Aleatório</button>

        <button onclick="editarListaExamesComSenha()">Editar Lista de Exames</button>

        <p>Voltar para o <a href="index.html">Cadastro de Exames</a></p>
    </div>

    <div id="editorExames">
        <h3>Editar Lista de Exames</h3>
        <textarea id="listaExamesEditor" rows="15" placeholder="Digite um exame por linha."></textarea><br>
        <button onclick="salvarListaExamesNoGitHub()">Salvar Alterações</button>
        <button onclick="document.getElementById('editorExames').style.display='none';">Cancelar</button>
    </div>

    <script type="module">
        // Importa as funções do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, limit, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        
        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA_LEim5s-_NSCk3ySVCcUzDjIq0RPlvnA",
            authDomain: "sislab-cetep.firebaseapp.com",
            projectId: "sislab-cetep",
            storageBucket: "sislab-cetep.firebasestorage.app",
            messagingSenderId: "958611861664",
            appId: "1:958611861664:web:97a3755f2b1958b0c8d9c5",
            measurementId: "G-3TL54MWJFS" // Opcional, se não usar analytics aqui
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); 

        // Torna as instâncias e funções do Firebase acessíveis globalmente para o JavaScript desta página
        window.firestoreDb = db;
        window.firebaseFirestoreCollection = collection;
        window.firebaseFirestoreGetDocs = getDocs;
        window.firebaseFirestoreQuery = query;
        window.firebaseFirestoreLimit = limit;
        window.firebaseFirestoreWriteBatch = writeBatch;
        window.firebaseFirestoreOrderBy = orderBy; 

        // Define a versão do script SISLAB para uso nesta página
        window.SISLAB_VERSION = "2.0.16"; /* */

        // --- Configuração da GIST Pública (para lista de exames) ---
        const GITHUB_USERNAME = 'hyskal'; 
        const GIST_ID = '1c13fc257a5a7f42e09303eaf26da670'; 
        const GIST_FILENAME = 'exames.txt'; 
        // Token de Acesso Pessoal (PAT) para GitHub Gist - CUIDADO AO EXPOR
        const GITHUB_PAT_GIST = (function() {
            const p1 = "ghp_PksP";
            const p2 = "EYHmMl";
            const p3 = "xrC06k";
            const p4 = "c5lqB5";
            const p5 = "pbeq63";
            const p6 = "gT2Z3QV9";
            return p1 + p2 + p3 + p4 + p5 + p6;
        })();

        // Função de depuração dummy para evitar erros quando chamadas de funções inexistentes do script principal
        function carregarExames() {
            console.log("Admin: carregarExames() chamado. Nenhuma ação no DOM desta página.");
        }

        // Função para exibir o Log Geral de Inventário, agora com camada de senha
        async function mostrarLogGeralInventario() {
            const now = new Date();
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const SENHA_DINAMICA_ESPERADA = "sislab" + hour + minute; 

            const senhaDigitada = prompt(`Para acessar o Log Geral, digite a senha.`);
            if (senhaDigitada === null) {
                alert("Acesso cancelado.");
                return;
            }
            if (senhaDigitada === SENHA_DINAMICA_ESPERADA) {
                alert("Redirecionando para a página do Log Geral de Inventário.");
                window.location.href = 'log_inventario.html'; 
            } else {
                alert('Senha incorreta. Acesso negado ao Log Geral.');
            }
        }

        // A função de limpar histórico, agora na página admin
        async function limparHistoricoAdmin() {
            const now = new Date();
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const SENHA_DINAMICA_ESPERADA = "sislab" + hour + minute; 

            const senhaDigitada = prompt(`Para limpar o histórico, digite a senha`);
            if (senhaDigitada === null) {
                return;
            }
            if (senhaDigitada === SENHA_DINAMICA_ESPERADA) {
                if (typeof window.firestoreDb === 'undefined' || !window.firestoreDb) {
                    alert("Firestore não inicializado. Limpeza de histórico desabilitada.");
                    return;
                }
                const confirmDeleteAll = confirm("Tem certeza que deseja apagar TODO o histórico do Firebase? Esta ação é irreversível e apagará todos os dados de pacientes!");
                if (!confirmDeleteAll) {
                    return;
                }

                try {
                    const historicoRef = window.firebaseFirestoreCollection(window.firestoreDb, 'historico');
                    const batchSize = 100;
                    
                    const deleteQueryBatch = async (dbInstance, queryToDelete) => {
                        const snapshot = await window.firebaseFirestoreGetDocs(queryToDelete);
                        if (snapshot.empty) { 
                            return 0;
                        }
                        const batch = window.firebaseFirestoreWriteBatch(dbInstance); 
                        snapshot.docs.forEach(d => {
                            batch.delete(d.ref);
                        });
                        await batch.commit();
                        return snapshot.size; 
                    };

                    let totalDeleted = 0;
                    let deletedCount;
                    do {
                        console.log("limparHistorico: Iniciando lote de exclusão.");
                        const q = window.firebaseFirestoreQuery(historicoRef, window.firebaseFirestoreOrderBy('protocolo', 'asc'), window.firebaseFirestoreLimit(batchSize)); 
                        deletedCount = await deleteQueryBatch(window.firestoreDb, q);
                        totalDeleted += deletedCount;
                        console.log(`Apagados ${deletedCount} documentos. Total: ${totalDeleted}`);
                        await new Promise(resolve => setTimeout(resolve, 50)); 
                    } while (deletedCount === batchSize);

                    alert(`Histórico apagado com sucesso do Firebase! Total de ${totalDeleted} registros.`);
                } catch (error) {
                    console.error("Erro ao limpar histórico do Firebase:", error);
                    alert("Erro ao limpar histórico do Firebase. Verifique o console e regras do Firestore.");
                }

            } else {
                alert('Senha incorreta. Histórico não foi limpo.');
            }
        }

        // Função para abrir index.html em nova aba com parâmetro para gerar paciente aleatório
        async function gerarNovoPacienteAleatorio() {
            alert("Uma nova aba será aberta para gerar um paciente aleatório.");
            window.open('index.html?gerar=ficticio', '_blank'); 
        }

        // --- Funções de Edição da Lista de Exames ---

        function editarListaExamesComSenha() {
            console.log("editListaExamesComSenha: Solicitando senha para edição de lista de exames.");
            const now = new Date();
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const SENHA_DINAMICA_ESPERADA = "sislab" + hour + minute; 

            const senhaDigitada = prompt(`Para editar a lista de exames, digite a senha.`);
            if (senhaDigitada === null) {
                console.log("editListaExamesComSenha: Usuário cancelou a entrada da senha.");
                return;
            }
            if (senhaDigitada === SENHA_DINAMICA_ESPERADA) {
                console.log("editListaExamesComSenha: Senha correta. Carregando lista para edição.");
                carregarListaExamesParaEdicao();
            } else {
                alert('Senha incorreta. Edição não permitida.');
                console.log("editListaExamesComSenha: Senha incorreta.");
            }
        }

        async function carregarListaExamesParaEdicao() {
            console.log("carregarListaExamesParaEdicao: Iniciando carregamento da lista de exames para edição.");
            const editorElement = document.getElementById('editorExames');
            const textarea = document.getElementById('listaExamesEditor');

            try {
                const timestamp = new Date().getTime();
                const gistRawUrl = `https://gist.githubusercontent.com/${GITHUB_USERNAME}/${GIST_ID}/raw/${GIST_FILENAME}?t=${timestamp}`;
                console.log("carregarListaExamesParaEdicao: Buscando Gist em:", gistRawUrl);
                const response = await fetch(gistRawUrl);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao buscar lista de exames da Gist: ${response.status} - ${errorText}`);
                }

                const fileContent = await response.text();
                textarea.value = fileContent;
                editorElement.style.display = 'block';
                alert('Lista de exames carregada para edição. Lembre-se: um exame por linha.');
                console.log("carregarListaExamesParaEdicao: Lista de exames carregada e editor exibido.");

            } catch (error) {
                console.error("carregarListaExamesParaEdicao: Erro ao carregar lista de exames da Gist:", error);
                alert("Não foi possível carregar a lista de exames para edição. Verifique o console e a Gist ID.");
            }
        }

        async function salvarListaExamesNoGitHub() {
            console.log("salvarListaExamesNoGitHub: Iniciando salvamento da lista de exames no GitHub.");
            const textarea = document.getElementById('listaExamesEditor');
            const novoConteudo = textarea.value;

            const confirmSave = confirm("Deseja realmente salvar essas alterações na Gist? Isso fará uma atualização.");
            if (!confirmSave) {
                console.log("salvarListaExamesNoGitHub: Usuário cancelou o salvamento.");
                return;
            }

            try {
                const gistApiUrl = `https://api.github.com/gists/${GIST_ID}`;
                console.log("salvarListaExamesNoGitHub: Enviando PATCH para Gist API:", gistApiUrl);
                
                const response = await fetch(gistApiUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_PAT_GIST}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        files: {
                            [GIST_FILENAME]: {
                                content: novoConteudo
                            }
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ao salvar na Gist: ${response.status} - ${errorText}`);
                }

                alert('Lista de exames atualizada com sucesso na Gist!');
                document.getElementById('editorExames').style.display = 'none';
                carregarExames(); 
                console.log("salvarListaExamesNoGitHub: Lista de exames salva e editor ocultado.");
            } catch (error) {
                console.error("salvarListaExamesNoGitHub: Erro ao salvar lista de exames na Gist:", error);
                alert("Não foi possível salvar a lista na Gist. Verifique o console, seu PAT e permissões.");
            }
        }

        // Script para aplicar a versão do SISLAB ao título da página
        document.addEventListener('DOMContentLoaded', () => {
            const titleElement = document.getElementById('adminTitle'); 
            if (titleElement && window.SISLAB_VERSION) {
                const currentTitle = titleElement.textContent;
                const newTitle = currentTitle.replace(/SISLAB (V\d+\.\d+\.\d+)?/, `SISLAB V${window.SISLAB_VERSION}`);
                titleElement.textContent = newTitle;
            }
        });
    </script>

</body>
</html>
